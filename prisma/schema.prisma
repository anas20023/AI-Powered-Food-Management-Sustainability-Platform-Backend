generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model aiprediction {
  id         Int      @id @default(autoincrement())
  upload_id  Int?
  user_id    Int?
  payload    Json?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  upload     upload?  @relation("AiPrediction_Upload", fields: [upload_id], references: [id])
  user       user?    @relation("AiPrediction_User", fields: [user_id], references: [id])

  @@index([upload_id])
  @@index([user_id])
}

model fooditem {
  id              Int               @id @default(autoincrement())
  user_id         Int?
  name            String
  category        fooditem_category
  expiration_days Int?
  cost_per_unit   Int?
  unit            String?
  created_at      DateTime          @default(now())
  updated_at      DateTime          @updatedAt
  uploads         UploadFoodItem[]
  user            user?             @relation("FoodItem_User", fields: [user_id], references: [id])
  inventories     inventory[]       @relation("Inventory_FoodItem")
  logs            log[]             @relation("Log_FoodItem")

  @@index([user_id])
}

model inventory {
  id             Int              @id @default(autoincrement())
  user_id        Int
  food_item_id   Int?
  status         inventory_status @default(Available)
  quantity       Int              @default(0)
  unit           String?
  purchased_date DateTime?
  expiry_date    DateTime?
  notes          String?
  created_at     DateTime         @default(now())
  updated_at     DateTime         @updatedAt
  fooditem       fooditem?        @relation("Inventory_FoodItem", fields: [food_item_id], references: [id])
  user           user             @relation("Inventory_User", fields: [user_id], references: [id])
  uploads        upload[]         @relation("Upload_Inventory")

  @@index([food_item_id])
  @@index([user_id])
}

model log {
  id           Int           @id @default(autoincrement())
  log_title    String?
  user_id      Int
  food_item_id Int?
  quantity     Int           @default(0)
  category     log_category?
  logged_at    DateTime      @default(now())
  created_at   DateTime      @default(now())
  updated_at   DateTime      @updatedAt
  fooditem     fooditem?     @relation("Log_FoodItem", fields: [food_item_id], references: [id])
  user         user          @relation("Log_User", fields: [user_id], references: [id])
  uploads      upload[]      @relation("Upload_Log")

  @@index([food_item_id])
  @@index([user_id])
}

model resource {
  id               Int                        @id @default(autoincrement())
  title            String
  description      String?
  url              String?
  related_category resource_related_category?
  type             String?
  created_at       DateTime                   @default(now())
  updated_at       DateTime                   @updatedAt
}

model upload {
  id                      Int              @id @default(autoincrement())
  filename                String
  url                     String
  user_id                 Int?
  associated_inventory_id Int?
  associated_log_id       Int?
  created_at              DateTime         @default(now())
  updated_at              DateTime         @updatedAt
  fooditems               UploadFoodItem[]
  ai_predictions          aiprediction[]   @relation("AiPrediction_Upload")
  associated_inventory    inventory?       @relation("Upload_Inventory", fields: [associated_inventory_id], references: [id])
  associated_log          log?             @relation("Upload_Log", fields: [associated_log_id], references: [id])
  user                    user?            @relation("Upload_User", fields: [user_id], references: [id])

  @@index([associated_inventory_id])
  @@index([associated_log_id])
  @@index([user_id])
}

/// Join table for upload <-> fooditem many-to-many
model UploadFoodItem {
  id         Int      @id @default(autoincrement())
  uploadId   Int
  foodItemId Int
  created_at DateTime @default(now())
  fooditem   fooditem @relation(fields: [foodItemId], references: [id], onDelete: Cascade)
  upload     upload   @relation(fields: [uploadId], references: [id], onDelete: Cascade)

  @@unique([uploadId, foodItemId])
  @@index([uploadId])
  @@index([foodItemId])
}

model user {
  id                  Int            @id @default(autoincrement())
  full_name           String
  email               String         @unique
  role                user_role?
  password_hash       String
  household_size      Int?
  dietary_preferences Json?
  budget_range        String?
  location            String?
  created_at          DateTime       @default(now())
  updated_at          DateTime       @updatedAt
  ai_predictions      aiprediction[] @relation("AiPrediction_User")
  fooditems           fooditem[]     @relation("FoodItem_User")
  inventories         inventory[]    @relation("Inventory_User")
  logs                log[]          @relation("Log_User")
  uploads             upload[]       @relation("Upload_User")
}

model consumption {
  id           Int       @id @default(autoincrement())
  user_id      Int
  food_item_id Int
  cost         Int
  quantity     Int
  category     String?   @db.VarChar(36)
  created_at   DateTime? @default(now())
  updated_at   DateTime? @updatedAt

  @@map("consumption")
}

enum fooditem_category {
  Snacks
  Vegetable
  Meat
  Dairy
  Drinks
  Fast_Food
}

enum inventory_status {
  Available
  Expired
  Consumed
}

enum user_role {
  Individual
  Family
  Community
}

enum resource_related_category {
  Waste_Reduction
  Budget_Tips
  Dietary_Tips
  Meal_Planning
  Storage_Tips
}

enum log_category {
  Snacks
  Vegetable
  Meat
  Dairy
  Drinks
  Fast_Food
}
